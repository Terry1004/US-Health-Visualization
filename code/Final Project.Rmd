---
title: "Final Project"
author: "Xinxin Huang"
date: "2018/11/1"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

```{r readfile}
measureHD <-read.csv("~xinxinhuang/Desktop/Data Visualization/US-Health-Visualization-master/data/measures_of_birth_and_death.csv")

preventive<-read.csv("~xinxinhuang/Desktop/Data Visualization/US-Health-Visualization-master/data/preventive_services_use.csv")
```

```{r filter01}
measureHD_df1<- measureHD %>% filter(measureHD$MOBD_Time_Span=="2001-2003")
measureHD_df1 <- select(measureHD_df1, -contains("CI"))
```

```{r filter02}
preventive_df1 <- select(preventive, -contains("CI"))
preventive_df1<- preventive_df1 %>% filter(preventive_df1$ID_Time_Span=="2001-2003")
```

```{r merge}
merge_df<- merge(measureHD_df1, preventive_df1, by="County_FIPS_Code", all=TRUE)
```

```{r transtocolumn}
merge_df$birth <- with(merge_df, paste(CHSI_State_Name.x, '<br>', "LBW", LBW, "VLBW", VLBW, "<br>",
                           "Premature", Premature, "Under_18", Under_18 ))
```

```{r filter03}
measureHD_df2<-measureHD_df1 %>% select(CHSI_County_Name,CHSI_State_Name, LBW,LBW_Ind, Min_LBW,Max_LBW,Infant_Mortality,Late_Care, Late_Care_Ind,Unmarried,Unmarried_Ind,Over_40,Over_40_Ind,IM_Wh_Non_Hisp,IM_Bl_Non_Hisp,IM_Hisp)

measureHD_df2<- measureHD_df1%>% filter(measureHD_df1$Late_Care>0 & measureHD_df1$Late_Care_Ind>0)

```
```{r graph1}
library(ggplot2)

ggplot(measureHD_df2, aes(x=Late_Care, y =Infant_Mortality, col=CHSI_State_Name ))+geom_point()

```

```{r clean1}
library(tidyr)

measureHD_df2 <-gather(measureHD_df2, key = variable, value = Value, Late_Care, LBW, Unmarried)
```
```{r graph2}
library(forcats)
g1<-ggplot(measureHD_df2, aes(x=Value, y = fct_reorder2(CHSI_State_Name, fct_rev(variable),-Value)))+geom_point(aes(col=variable))+scale_color_manual("Variables", values = c("black", "skyblue", "rosybrown")) +ylab("State_Name")

g1


```

```{r map1}
library(plotly)
l <- list(color = toRGB("white"), width = 2)
g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)

p <- plot_geo(merge_df, locationmode = 'USA-states') %>%
  add_trace(
    z = ~LBW, text = ~birth, locations = ~CHSI_State_Abbr.x,
    color = ~LBW, colors = 'Purples'
  ) %>%
  colorbar(title = "LBW") %>%
  layout(
    title = '2001-2003 US Low Birth Weights by State',
    geo = g
  )
chart_link = api_create(p, filename="choropleth-ag")
chart_link

```